{% extends "base.html" %}

{% block content %}
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8 mx-auto">
                <h1 class="text-center mb-4">
                    <i class="fas fa-money-bill-wave"></i>
                    Cálculo de Vencimentos
                </h1>
                
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Calcular Dados de Vencimento</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">
                            Este formulário calcula os dados de vencimento 
                            do professor extraídos da API de Fichas Financeiras.
                        </p>
                        
                        <form method="post" id="vencimentoForm">
                            {% csrf_token %}
                            
                            <div class="form-group mb-3">
                                <label for="{{ form.matricula.id_for_label }}" class="form-label">
                                    {{ form.matricula.label }}
                                </label>
                                {{ form.matricula }}
                                <div class="form-text">{{ form.matricula.help_text }}</div>
                                {% if form.matricula.errors %}
                                    <div class="text-danger">
                                        {% for error in form.matricula.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                
                                <!-- Professor validation feedback -->
                                <div id="professor-validation" class="mt-2" style="display: none;">
                                    <div id="professor-info" class="alert alert-info">
                                        <i class="fas fa-user"></i>
                                        <span id="professor-name"></span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="{{ form.data_inicio.id_for_label }}" class="form-label">
                                            {{ form.data_inicio.label }}
                                        </label>
                                        {{ form.data_inicio }}
                                        <div class="form-text">{{ form.data_inicio.help_text }}</div>
                                        {% if form.data_inicio.errors %}
                                            <div class="text-danger">
                                                {% for error in form.data_inicio.errors %}
                                                    <small>{{ error }}</small>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="{{ form.data_fim.id_for_label }}" class="form-label">
                                            {{ form.data_fim.label }}
                                        </label>
                                        {{ form.data_fim }}
                                        <div class="form-text">{{ form.data_fim.help_text }}</div>
                                        {% if form.data_fim.errors %}
                                            <div class="text-danger">
                                                {% for error in form.data_fim.errors %}
                                                    <small>{{ error }}</small>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Vencimento preview -->
                            <div id="vencimento-preview" class="alert alert-warning" style="display: none;">
                                <h6><i class="fas fa-eye"></i> Prévia dos Dados de Vencimento:</h6>
                                <div id="preview-content"></div>
                            </div>
                            
                            <!-- Form errors -->
                            {% if form.non_field_errors %}
                                <div class="alert alert-danger">
                                    {% for error in form.non_field_errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            <div class="d-grid gap-2">
                                <button type="button" id="previewBtn" class="btn btn-outline-primary">
                                    <i class="fas fa-search"></i> Visualizar Dados
                                </button>
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fas fa-calculator"></i> Calcular Vencimentos
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Results section -->
                {% if resultados %}
                <div class="card mt-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-money-bill-wave"></i>
                            Resultados dos Vencimentos
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6><strong>Professor:</strong> {{ resultados.professor_name }}</h6>
                                <p><strong>Matrícula:</strong> {{ resultados.matricula }}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Período:</strong> {{ resultados.periodo_inicio }} a {{ resultados.periodo_fim }}</p>
                                <p><strong>Total de Períodos:</strong> {{ resultados.periodos|length }}</p>
                            </div>
                        </div>
                        
                        {% if resultados.periodos %}
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Mês/Ano</th>
                                        <th>Total Vencimentos</th>
                                        <th>Quantidade de Registros</th>
                                        <th>Detalhes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for periodo in resultados.periodos %}
                                    <tr>
                                        <td>{{ periodo.mes_formatado }}</td>
                                        <td>R$ {{ periodo.total_vencimentos|floatformat:2 }}</td>
                                        <td>{{ periodo.quantidade_registros }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-info" type="button" 
                                                    data-bs-toggle="collapse" 
                                                    data-bs-target="#detalhes-{{ forloop.counter }}" 
                                                    aria-expanded="false">
                                                Ver Detalhes
                                            </button>
                                        </td>
                                    </tr>
                                    <tr class="collapse" id="detalhes-{{ forloop.counter }}">
                                        <td colspan="4">
                                            <div class="card card-body">
                                                <h6>Registros do período:</h6>
                                                {% for registro in periodo.registros %}
                                                <div class="row">
                                                    <div class="col-md-4">
                                                        <strong>{{ registro.nome_verba }}</strong>
                                                    </div>
                                                    <div class="col-md-3">
                                                        Código: {{ registro.cod_verba }}
                                                    </div>
                                                    <div class="col-md-3">
                                                        Valor: R$ {{ registro.valor|floatformat:2 }}
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">
                                            Nenhum dado encontrado para o período selecionado
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-3">
                            <h6>Resumo Geral:</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">Total de Períodos</h5>
                                            <h3 class="text-primary">{{ resultados.periodos|length }}</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">Valor Total</h5>
                                            <h3 class="text-success">
                                                {% with total=0 %}
                                                    {% for periodo in resultados.periodos %}
                                                        {% with total=total|add:periodo.total_vencimentos %}{% endwith %}
                                                    {% endfor %}
                                                {% endwith %}
                                                R$ {% widthratio resultados.periodos|length 1 resultados.periodos|length as dummy %}
                                                {{ resultados.periodos.0.total_vencimentos|add:resultados.periodos.1.total_vencimentos|default:0|floatformat:2 }}
                                            </h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">Período</h5>
                                            <h6 class="text-info">{{ resultados.periodo_inicio }} a {{ resultados.periodo_fim }}</h6>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            Nenhum dado de vencimento foi encontrado para os parâmetros informados.
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Messages -->
                {% if messages %}
                    <div class="mt-3">
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
                
                <!-- Navigation -->
                <div class="text-center mt-4">
                    <a href="{% url 'vencimento' %}" class="btn btn-secondary">
                        <i class="fas fa-refresh"></i> Nova Consulta
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript for AJAX functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const matriculaField = document.getElementById('{{ form.matricula.id_for_label }}');
            const dataInicioField = document.getElementById('{{ form.data_inicio.id_for_label }}');
            const dataFimField = document.getElementById('{{ form.data_fim.id_for_label }}');
            const previewBtn = document.getElementById('previewBtn');
            const professorValidation = document.getElementById('professor-validation');
            const professorName = document.getElementById('professor-name');
            const vencimentoPreview = document.getElementById('vencimento-preview');
            const previewContent = document.getElementById('preview-content');
            
            // Validate professor when matricula changes
            matriculaField.addEventListener('blur', function() {
                const matricula = this.value.trim();
                if (matricula) {
                    validateProfessor(matricula);
                }
            });
            
            // Preview vencimento data
            previewBtn.addEventListener('click', function() {
                const matricula = matriculaField.value.trim();
                const dataInicio = dataInicioField.value;
                const dataFim = dataFimField.value;
                
                if (!matricula || !dataInicio || !dataFim) {
                    alert('Por favor, preencha todos os campos antes de visualizar os dados.');
                    return;
                }
                
                previewVencimentoData(matricula, dataInicio, dataFim);
            });
            
            function validateProfessor(matricula) {
                fetch(`{% url 'validate_professor' %}?matricula=${matricula}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.valid) {
                            professorName.textContent = data.professor.servidor.SERVIDOR_NOME;
                            professorValidation.style.display = 'block';
                            professorValidation.className = 'mt-2';
                            document.getElementById('professor-info').className = 'alert alert-success';
                        } else {
                            professorValidation.style.display = 'block';
                            document.getElementById('professor-info').className = 'alert alert-danger';
                            professorName.textContent = data.message;
                        }
                    })
                    .catch(error => {
                        console.error('Error validating professor:', error);
                    });
            }
            
            function previewVencimentoData(matricula, dataInicio, dataFim) {
                previewBtn.disabled = true;
                previewBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Carregando...';
                
                fetch(`{% url 'vencimento_preview' %}?matricula=${matricula}&data_inicio=${dataInicio}&data_fim=${dataFim}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            let html = `
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>Professor:</strong> ${data.professor_name}<br>
                                        <strong>Período:</strong> ${data.periodo_inicio} a ${data.periodo_fim}<br>
                                        <strong>Total de Registros:</strong> ${data.total_registros}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Valor Total:</strong> R$ ${data.total_valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}<br>
                                        <strong>Valor Médio:</strong> R$ ${data.valor_medio.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                                    </div>
                                </div>
                            `;
                            
                            if (Object.keys(data.monthly_summary).length > 0) {
                                html += '<hr><h6>Resumo Mensal:</h6><div class="row">';
                                let count = 0;
                                for (const [month, value] of Object.entries(data.monthly_summary)) {
                                    if (count % 3 === 0 && count > 0) html += '</div><div class="row">';
                                    html += `<div class="col-md-4"><small>${month}: R$ ${value.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</small></div>`;
                                    count++;
                                }
                                html += '</div>';
                            }
                            
                            previewContent.innerHTML = html;
                            vencimentoPreview.style.display = 'block';
                        } else {
                            previewContent.innerHTML = `<div class="text-danger">${data.message}</div>`;
                            vencimentoPreview.style.display = 'block';
                            vencimentoPreview.className = 'alert alert-danger';
                        }
                    })
                    .catch(error => {
                        console.error('Error getting vencimento preview:', error);
                        previewContent.innerHTML = '<div class="text-danger">Erro ao buscar dados de vencimento.</div>';
                        vencimentoPreview.style.display = 'block';
                        vencimentoPreview.className = 'alert alert-danger';
                    })
                    .finally(() => {
                        previewBtn.disabled = false;
                        previewBtn.innerHTML = '<i class="fas fa-search"></i> Visualizar Dados';
                    });
            }
        });
    </script>
{% endblock %}
