{% extends "base.html" %}

{% block content %}
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8 mx-auto">
                <h1 class="text-center mb-4">
                    <i class="fas fa-money-bill-wave"></i>
                    C√°lculo de Vencimentos
                </h1>
                
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Calcular Dados de Vencimento</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">
                            Este formul√°rio calcula os dados de vencimento 
                            do professor extra√≠dos da API de Fichas Financeiras.
                        </p>
                        
                        <form method="post" id="vencimentoForm">
                            {% csrf_token %}
                            
                            <div class="form-group mb-3">
                                <label for="{{ form.matricula.id_for_label }}" class="form-label">
                                    {{ form.matricula.label }}
                                </label>
                                {{ form.matricula }}
                                <div class="form-text">{{ form.matricula.help_text }}</div>
                                {% if form.matricula.errors %}
                                    <div class="text-danger">
                                        {% for error in form.matricula.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="{{ form.data_inicio.id_for_label }}" class="form-label">
                                            {{ form.data_inicio.label }}
                                        </label>
                                        {{ form.data_inicio }}
                                        <div class="form-text">{{ form.data_inicio.help_text }}</div>
                                        {% if form.data_inicio.errors %}
                                            <div class="text-danger">
                                                {% for error in form.data_inicio.errors %}
                                                    <small>{{ error }}</small>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="{{ form.data_fim.id_for_label }}" class="form-label">
                                            {{ form.data_fim.label }}
                                        </label>
                                        {{ form.data_fim }}
                                        <div class="form-text">{{ form.data_fim.help_text }}</div>
                                        {% if form.data_fim.errors %}
                                            <div class="text-danger">
                                                {% for error in form.data_fim.errors %}
                                                    <small>{{ error }}</small>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Form errors -->
                            {% if form.non_field_errors %}
                                <div class="alert alert-danger">
                                    {% for error in form.non_field_errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            <div class="d-grid">
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fas fa-calculator"></i> Calcular Vencimentos
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Results section -->
                {% if resultados %}
                <div class="card mt-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-money-bill-wave"></i>
                            Resultados dos Vencimentos
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- JSON File Save Status -->
                        {% if json_file_info %}
                        <div class="alert {% if json_file_info.success %}alert-success{% else %}alert-warning{% endif %} mb-3">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    {% if json_file_info.success %}
                                        <i class="fas fa-file-download me-2"></i>
                                        <strong>Arquivo JSON Criado:</strong> {{ json_file_info.filename }}
                                        <br><small class="text-muted">
                                            üìÅ <strong>Local:</strong> {{ json_file_info.file_path }}
                                            {% if json_file_info.record_count %}
                                            <br>üìä <strong>Registros salvos:</strong> {{ json_file_info.record_count }} vencimentos
                                            {% endif %}
                                        </small>
                                        <br><small class="text-info">
                                            üí° <strong>Estrutura:</strong> Dados organizados com metadados, resumo mensal, dados completos do professor e registros individuais para an√°lise externa.
                                        </small>
                                    {% else %}
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>Aviso:</strong> {{ json_file_info.message }}
                                    {% endif %}
                                </div>
                                {% if json_file_info.success %}
                                <div>
                                    <span class="badge bg-success fs-6">
                                        <i class="fas fa-check"></i> JSON Salvo
                                    </span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6><strong>Professor:</strong> {{ resultados.professor_name }}</h6>
                                <p><strong>Matr√≠cula:</strong> {{ resultados.matricula }}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Per√≠odo:</strong> {{ resultados.periodo_inicio }} a {{ resultados.periodo_fim }}</p>
                                <p><strong>Total de Per√≠odos:</strong> {{ resultados.periodos|length }}</p>
                            </div>
                        </div>
                        
                        {% if resultados.periodos %}
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead class="table-dark">
                                    <tr>
                                        <th>M√™s/Ano</th>
                                        <th>Total Vencimentos</th>
                                        <th>Quantidade de Registros</th>
                                        <th>Detalhes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for periodo in resultados.periodos %}
                                    <tr>
                                        <td>{{ periodo.mes_formatado }}</td>
                                        <td>R$ {{ periodo.total_vencimentos|floatformat:2 }}</td>
                                        <td>{{ periodo.quantidade_registros }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-info" type="button" 
                                                    data-bs-toggle="collapse" 
                                                    data-bs-target="#detalhes-{{ forloop.counter }}" 
                                                    aria-expanded="false">
                                                Ver Detalhes
                                            </button>
                                        </td>
                                    </tr>
                                    <tr class="collapse" id="detalhes-{{ forloop.counter }}">
                                        <td colspan="4">
                                            <div class="card card-body">
                                                <h6>Registros do per√≠odo:</h6>
                                                {% for registro in periodo.registros %}
                                                <div class="row">
                                                    <div class="col-md-4">
                                                        <strong>{{ registro.nome_verba }}</strong>
                                                    </div>
                                                    <div class="col-md-3">
                                                        C√≥digo: {{ registro.cod_verba }}
                                                    </div>
                                                    <div class="col-md-3">
                                                        Valor: R$ {{ registro.valor|floatformat:2 }}
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">
                                            Nenhum dado encontrado para o per√≠odo selecionado
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-3">
                            <h6>Resumo Geral:</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">Total de Per√≠odos</h5>
                                            <h3 class="text-primary">{{ resultados.periodos|length }}</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">Valor Total</h5>
                                            <h3 class="text-success">
                                                {% with total=0 %}
                                                    {% for periodo in resultados.periodos %}
                                                        {% with total=total|add:periodo.total_vencimentos %}{% endwith %}
                                                    {% endfor %}
                                                {% endwith %}
                                                R$ {% widthratio resultados.periodos|length 1 resultados.periodos|length as dummy %}
                                                {{ resultados.periodos.0.total_vencimentos|add:resultados.periodos.1.total_vencimentos|default:0|floatformat:2 }}
                                            </h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">Per√≠odo</h5>
                                            <h6 class="text-info">{{ resultados.periodo_inicio }} a {{ resultados.periodo_fim }}</h6>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            Nenhum dado de vencimento foi encontrado para os par√¢metros informados.
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Professor Complete Data Section -->
                {% if professor_data %}
                <div class="card mt-4">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-user-graduate"></i>
                            Dados Completos do Professor (API Response)
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Debug:</strong> Esta se√ß√£o mostra TODOS os dados do professor retornados pela API, 
                            incluindo informa√ß√µes pessoais e estrutura completa.
                        </div>
                        
                        <!-- Show professor data in a formatted way -->
                        <div class="accordion" id="professorDataAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="basicDataHeading">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" 
                                            data-bs-target="#basicDataCollapse" aria-expanded="true">
                                        <i class="fas fa-id-card me-2"></i>
                                        Informa√ß√µes B√°sicas do Servidor
                                    </button>
                                </h2>
                                <div id="basicDataCollapse" class="accordion-collapse collapse show">
                                    <div class="accordion-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <ul class="list-group">
                                                    <li class="list-group-item d-flex justify-content-between">
                                                        <strong>Nome:</strong>
                                                        <span>{{ professor_data.SERVIDOR_NOME|default:"N/A" }}</span>
                                                    </li>
                                                    <li class="list-group-item d-flex justify-content-between">
                                                        <strong>CPF:</strong>
                                                        <span>{{ professor_data.SERVIDOR_CPF|default:"N/A" }}</span>
                                                    </li>
                                                    <li class="list-group-item d-flex justify-content-between">
                                                        <strong>Matr√≠cula:</strong>
                                                        <span>{{ professor_data.SERVIDOR_MATRICULA|default:"N/A" }}</span>
                                                    </li>
                                                </ul>
                                            </div>
                                            <div class="col-md-6">
                                                <ul class="list-group">
                                                    <li class="list-group-item d-flex justify-content-between">
                                                        <strong>ID Servidor:</strong>
                                                        <span>{{ professor_data.SERVIDOR_ID|default:"N/A" }}</span>
                                                    </li>
                                                    <li class="list-group-item d-flex justify-content-between">
                                                        <strong>Total Fichas:</strong>
                                                        <span>{{ professor_data.fichasFinanceiras|length|default:"0" }}</span>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="rawDataHeading">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                            data-bs-target="#rawDataCollapse" aria-expanded="false">
                                        <i class="fas fa-code me-2"></i>
                                        Dados Brutos Completos (JSON)
                                    </button>
                                </h2>
                                <div id="rawDataCollapse" class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        <div class="bg-dark text-light p-3 rounded">
                                            <pre style="white-space: pre-wrap; font-size: 12px;">{{ professor_data }}</pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Messages -->
                {% if messages %}
                    <div class="mt-3">
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
                
                <!-- Navigation -->
                <div class="text-center mt-4">
                    <a href="{% url 'vencimento' %}" class="btn btn-secondary">
                        <i class="fas fa-refresh"></i> Nova Consulta
                    </a>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
